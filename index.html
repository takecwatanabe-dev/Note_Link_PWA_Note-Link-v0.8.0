<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no, viewport-fit=cover" />
<title>Note Link v0.7.2 / No.19</title>
<meta name="theme-color" content="#0a0a0a" />
<style>
  :root{
    --bg:#0c0e12; --panel:#12151b; --ink:#e9eef5; --ink-2:#b9c2cf;
    --blue:#5570ff; --green:#22c55e; --bd:#2a3140;
    --sidebar-w:56px; --topbar-h:40px; --btn:40px; --icon:20px; --panel-w:320px;
    --shadow:0 18px 40px rgba(0,0,0,.35),0 3px 10px rgba(0,0,0,.25);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; background:#0a0c10; color:var(--ink);
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Noto Sans JP",Arial,sans-serif;
    -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    -webkit-tap-highlight-color:transparent;
  }
  [hidden]{display:none !important;}

  /* ===== layout ===== */
  .app{display:grid; grid-template-columns:var(--sidebar-w) 1fr; grid-template-rows:var(--topbar-h) 1fr; height:100vh;}
  .sidebar{
    grid-row:1 / span 2; grid-column:1; background:#0d1016; border-right:1px solid var(--bd); z-index:10;
    display:flex; flex-direction:column; align-items:center; gap:8px; padding:8px 6px;
  }
  .topbar{
    grid-row:1; grid-column:2; z-index:9;
    background:linear-gradient(0deg, #3b59ff, #5c78ff); color:#fff;
    border-bottom:1px solid rgba(0,0,0,.3);
    display:flex; align-items:center; gap:8px; padding:6px 10px;
  }
  .title{font-weight:800; margin-right:auto}
  .main{grid-row:2; grid-column:2; position:relative; background:#0f1218; overflow:hidden}

  /* ===== buttons ===== */
  .sbtn{
    width:var(--btn); height:var(--btn); border-radius:12px;
    background:#121722; border:1px solid var(--bd); color:var(--ink);
    display:grid; place-items:center; cursor:pointer; user-select:none;
    transition:background .12s, transform .02s, border-color .12s;
  }
  .sbtn:hover{background:#172033} .sbtn:active{transform:scale(.98)}
  .sbtn[aria-pressed="true"]{outline:none}
  .sbtn.is-open{box-shadow:0 0 0 2px var(--green) inset;}
  .icon{width:var(--icon); height:var(--icon); display:block}

  .tbtn{height:28px; min-width:40px; padding:0 10px; border-radius:8px;
        background:rgba(255,255,255,.15); color:#fff; border:1px solid rgba(255,255,255,.25); cursor:pointer;}
  .tbtn:hover{background:rgba(255,255,255,.25)}
  .zoom{font-weight:800; min-width:64px; text-align:center}

  /* ===== panels ===== */
  .panel{
    position:fixed; width:var(--panel-w); background:var(--panel); color:var(--ink);
    border:1px solid var(--bd); border-radius:14px; box-shadow:var(--shadow); z-index:1000;
  }
  .p-inner{padding:14px}
  .p-title{margin:0 0 10px 0; font-size:15px; font-weight:800}
  .row{display:flex; align-items:center; justify-content:space-between; gap:10px; margin:8px 0}
  .label{font-size:13px; color:var(--ink-2)}
  input[type="range"]{width:64%}
  .btn{display:block; width:100%; border-radius:10px; border:1px solid var(--bd); background:#171c27; color:var(--ink); padding:9px 10px; cursor:pointer}
  .btn:hover{background:#1b2130}

  /* ===== workspace & canvas ===== */
  .workspace{position:absolute; inset:0; background:#0f1218; touch-action:none;} /* ← ページスクロール/ピンチ無効化 */
  .viewport{position:absolute; left:0; top:0; transform-origin:0 0;}
  canvas{position:absolute; left:0; top:0; display:block}
  #overlay{pointer-events:none}

  /* grid (visual only) */
  .workspace.grid-on{
    background:
      linear-gradient(rgba(255,255,255,.05) 1px, transparent 1px) 0 0/24px 24px,
      linear-gradient(90deg, rgba(255,255,255,.05) 1px, transparent 1px) 0 0/24px 24px,
      #0f1218;
  }
</style>
</head>
<body>
  <div class="app">
    <!-- ===== 左サイドバー（v0.7） ===== -->
    <aside class="sidebar" aria-label="tool sidebar">
      <button class="sbtn" id="penBtn" title="ペン" aria-pressed="true">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25Zm18-11.5a1 1 0 0 0 0-1.41l-1.59-1.59a1 1 0 0 0-1.41 0l-1.83 1.83 3.75 3.75L21 5.75Z" fill="currentColor"/></svg>
      </button>
      <button class="sbtn" id="markerBtn" title="マーカー" aria-pressed="false">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 15l6 6 12-12-6-6L3 15Zm0 0l-1 5 5-1" fill="currentColor"/></svg>
      </button>
      <button class="sbtn" id="lineBtn" title="直線" aria-pressed="false">
        <svg class="icon" viewBox="0 0 24 24"><path d="M4 20 L20 4" stroke="currentColor" stroke-width="2" fill="none" stroke-linecap="round"/></svg>
      </button>
      <button class="sbtn" id="eraserBtn" title="消しゴム" aria-pressed="false">
        <svg class="icon" viewBox="0 0 24 24"><path d="M16 3 21 8 9 20H4L16 8zM3 21h18" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button class="sbtn" id="handBtn" title="ハンドル（パン）" aria-pressed="false">
        <svg class="icon" viewBox="0 0 24 24"><path d="M6 12V6a1 1 0 1 1 2 0v6M9 12V5a1 1 0 1 1 2 0v7M12 12V4a1 1 0 1 1 2 0v8M15 13V7a1 1 0 1 1 2 0v8M6 13c-2 0-2 2-2 3 0 2 1 6 6 6h3c3 0 5-2 5-5v-3" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <button class="sbtn" id="gridBtn" title="グリッド表示" aria-pressed="false">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 3h18v18H3zM9 3v18M15 3v18M3 9h18M3 15h18" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      </button>
      <button class="sbtn" id="kbdBtn" title="キーボード" aria-haspopup="dialog" aria-controls="kbdPanel">
        <svg class="icon" viewBox="0 0 24 24"><path d="M3 6h18v12H3z M5 9h2 M8 9h2 M11 9h2 M14 9h2 M17 9h2 M5 12h2 M8 12h2 M11 12h2 M14 12h2 M17 12h2 M5 15h10" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/></svg>
      </button>
      <button class="sbtn" id="settingsBtn" title="設定" aria-haspopup="dialog" aria-controls="settingsPanel">
        <svg class="icon" viewBox="0 0 24 24"><path d="M12 8a4 4 0 1 1 0 8 4 4 0 0 1 0-8Zm8.9 3a8.3 8.3 0 0 0-.1-1l2-1.5-1.8-3.2-2.4.5a7.7 7.7 0 0 0-1.5-.9l-.4-2.4H7.3l-.4 2.4a7.7 7.7 0 0 0-1.5.9l-2.4-.5L1.2 8.1 3.2 9.6a8.3 8.3 0 0 0 0 2L1.2 13l1.8 3.2 2.4-.5c.5.4 1 .7 1.5.9l.4 2.4h6.4l.4-2.4c.5-.2 1-.5 1.5-.9l2.4.5 1.8-3.2-2-1.5c.1-.3.1-.7.1-1Z" fill="none" stroke="currentColor" stroke-width="2"/></svg>
      </button>
    </aside>

    <!-- ===== 上部バー ===== -->
    <header class="topbar" role="toolbar">
      <div class="title">Note Link v0.7.2 / No.19</div>
      <button class="tbtn" id="zoomOut" title="縮小">−</button>
      <button class="tbtn zoom" id="zoomDisplay" title="ズーム率">100%</button>
      <button class="tbtn" id="zoomIn" title="拡大">＋</button>
      <button class="tbtn" id="undoBtn" title="undo">undo</button>
      <button class="tbtn" id="redoBtn" title="redo">redo</button>
      <button class="tbtn" id="printBtn" title="印刷">印刷</button>
      <button class="tbtn" id="pngBtn" title="PNG書き出し">PNG</button>
      <button class="tbtn" id="shareBtn" title="共有">共有</button>
      <button class="tbtn" id="fsBtn" title="全画面">全画面</button>
    </header>

    <!-- ===== 作業面 ===== -->
    <section class="main">
      <div class="workspace" id="workspace" aria-label="作業領域">
        <div class="viewport" id="viewport">
          <canvas id="canvas"></canvas>
          <canvas id="overlay"></canvas>
        </div>
      </div>
    </section>
  </div>

  <!-- ===== パネル（中央固定／外側タップで閉じない） ===== -->
  <div class="panel" id="settingsPanel" role="dialog" aria-modal="false" hidden>
    <div class="p-inner" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
      <h3 class="p-title">設定</h3>
      <div class="row"><span class="label">色</span><input type="color" id="penColor" value="#ffffff" /></div>
      <div class="row"><span class="label">太さ</span><input type="range" id="penSize" min="1" max="20" step="0.5" value="2" /></div>
      <div class="row"><span id="penSizeLabel">2.0 px（0.53 mm）</span></div>
      <button class="btn" id="closeSettings">閉じる</button>
    </div>
  </div>
  <div class="panel" id="kbdPanel" role="dialog" aria-modal="false" hidden>
    <div class="p-inner" onclick="event.stopPropagation()" onmousedown="event.stopPropagation()" ontouchstart="event.stopPropagation()">
      <h3 class="p-title">キーボード設定</h3>
      <div class="row"><span class="label">文字サイズ</span><input type="range" id="fontSize" min="8" max="48" step="1" value="14" /></div>
      <div class="row"><span id="fontSizeLabel">14 pt（18.7 px）</span></div>
      <button class="btn" id="closeKbd">閉じる</button>
    </div>
  </div>

<script>
/* ===== Core State ===== */
const cssDPI=96, $=q=>document.querySelector(q);
const els={
  workspace:$('#workspace'), viewport:$('#viewport'),
  canvas:$('#canvas'), overlay:$('#overlay'),
  zoomOut:$('#zoomOut'), zoomIn:$('#zoomIn'), zoomDisplay:$('#zoomDisplay'),
  undo:$('#undoBtn'), redo:$('#redoBtn'), print:$('#printBtn'), png:$('#pngBtn'), share:$('#shareBtn'), fs:$('#fsBtn'),
  penBtn:$('#penBtn'), markerBtn:$('#markerBtn'), lineBtn:$('#lineBtn'), eraserBtn:$('#eraserBtn'), handBtn:$('#handBtn'), gridBtn:$('#gridBtn'),
  settingsBtn:$('#settingsBtn'), settingsPanel:$('#settingsPanel'), closeSettings:$('#closeSettings'),
  kbdBtn:$('#kbdBtn'), kbdPanel:$('#kbdPanel'), closeKbd:$('#closeKbd'),
  penSize:$('#penSize'), penSizeLabel:$('#penSizeLabel'), penColor:$('#penColor'),
  fontSize:$('#fontSize'), fontSizeLabel:$('#fontSizeLabel')
};
const ctx=els.canvas.getContext('2d'), octx=els.overlay.getContext('2d');
const app={tool:'pen', grid:false, scale:1, min:.25, max:4, step:.1, panX:0, panY:0,
  penSize:2, penColor:'#ffffff', fontPt:14,
  strokes:[], history:[], future:[],
  drawing:false, current:null, lineStart:null, handStart:null, pinch:null, activePointer:null};

/* ===== Layout ===== */
function fitCanvas(){const r=els.workspace.getBoundingClientRect(), d=Math.max(1,devicePixelRatio||1);
  [els.canvas,els.overlay].forEach(cv=>{if(cv.width!==Math.floor(r.width*d)||cv.height!==Math.floor(r.height*d)){cv.width=Math.floor(r.width*d);cv.height=Math.floor(r.height*d);cv.style.width=r.width+'px';cv.style.height=r.height+'px';}});
  redraw(); clearOverlay();}
function applyView(){els.viewport.style.transformOrigin='0 0'; els.viewport.style.transform=`translate(${app.panX}px,${app.panY}px) scale(${app.scale})`; els.zoomDisplay.textContent=Math.round(app.scale*100)+'%';}
function centerPanel(p){ p.style.left=`calc(50vw - ${p.offsetWidth/2}px)`; p.style.top=`calc(50vh - ${p.offsetHeight/2}px)`; }

/* ===== Units Labels ===== */
const pxToMm = px => px*25.4/cssDPI;
function updatePenLabel(){els.penSizeLabel.textContent=`${app.penSize.toFixed(1)} px（${pxToMm(app.penSize).toFixed(2)} mm）`}
function updateFontLabel(){const px=app.fontPt*cssDPI/72; els.fontSizeLabel.textContent=`${app.fontPt} pt（${px.toFixed(1)} px）`}

/* ===== Drawing ===== */
const clear=c=>c.clearRect(0,0,c.canvas.width,c.canvas.height), clearOverlay=()=>clear(octx);
const world2screen=p=>({x:p.x*app.scale+app.panX, y:p.y*app.scale+app.panY});
const screen2world=p=>({x:(p.x-app.panX)/app.scale, y:(p.y-app.panY)/app.scale});

function drawStroke(st){ctx.save(); const d=Math.max(1,devicePixelRatio||1); ctx.scale(d,d);
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.globalAlpha=st.alpha??1; ctx.globalCompositeOperation=st.comp||'source-over';
  ctx.strokeStyle=st.color||'#fff'; ctx.lineWidth=st.w||2;
  if(st.type==='free'||st.type==='marker'||st.type==='eraser'){ctx.beginPath(); st.pts.forEach((pt,i)=>{const s=world2screen(pt); if(i===0)ctx.moveTo(s.x,s.y); else ctx.lineTo(s.x,s.y);}); ctx.stroke();}
  else if(st.type==='line'){const a=world2screen(st.a), b=world2screen(st.b); ctx.beginPath(); ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y); ctx.stroke();}
  ctx.restore();}
function redraw(){clear(ctx); app.strokes.forEach(drawStroke);}
function drawPreview(pre){clearOverlay(); if(!pre)return; const d=Math.max(1,devicePixelRatio||1); octx.save(); octx.scale(d,d);
  octx.lineCap='round'; octx.lineJoin='round'; octx.setLineDash([6,6]); octx.globalAlpha=.95; octx.strokeStyle='#7ec8ff'; octx.lineWidth=app.penSize;
  if(pre.type==='line'){const a=world2screen(pre.a), b=world2screen(pre.b); octx.beginPath(); octx.moveTo(a.x,a.y); octx.lineTo(b.x,b.y); octx.stroke();
    const ang=Math.atan2(pre.b.y-pre.a.y, pre.b.x-pre.a.x)*180/Math.PI; const m={x:(a.x+b.x)/2,y:(a.y+b.y)/2};
    octx.setLineDash([]); octx.font='12px system-ui,sans-serif'; octx.strokeStyle='rgba(0,0,0,.6)'; octx.lineWidth=3; octx.strokeText(ang.toFixed(1)+'°', m.x+8, m.y-8);
    octx.fillStyle='#fff'; octx.fillText(ang.toFixed(1)+'°', m.x+8, m.y-8);}
  octx.restore();}

/* ===== Input (Pointer Events) ===== */
function setTool(t){app.tool=t; [[els.penBtn,'pen'],[els.markerBtn,'marker'],[els.lineBtn,'line'],[els.eraserBtn,'eraser'],[els.handBtn,'hand']]
  .forEach(([b,n])=>b&&b.setAttribute('aria-pressed', n===t?'true':'false'));}

function beginAt(p){
  const w=screen2world(p); app.drawing=true;
  if(app.tool==='pen'||app.tool==='marker'||app.tool==='eraser'){
    app.current={type:(app.tool==='eraser'?'eraser':app.tool==='marker'?'marker':'free'),
      pts:[w], w:app.penSize, color:app.penColor, alpha:app.tool==='marker'?0.55:1, comp:app.tool==='eraser'?'destination-out':'source-over'};
  }else if(app.tool==='line'){app.lineStart=w;}
  else if(app.tool==='hand'){app.handStart={x:w.x,y:w.y,panX:app.panX,panY:app.panY};}
}
function moveAt(p){
  if(!app.drawing) return; const w=screen2world(p);
  if(app.tool==='pen'||app.tool==='marker'||app.tool==='eraser'){
    app.current.pts.push(w); const arr=app.current.pts; if(arr.length>=3){const n=arr.length; arr[n-2].x=(arr[n-3].x+arr[n-2].x+arr[n-1].x)/3; arr[n-2].y=(arr[n-3].y+arr[n-2].y+arr[n-1].y)/3;}
    redraw(); clearOverlay();
  }else if(app.tool==='line'){redraw(); drawPreview({type:'line',a:app.lineStart,b:w});}
  else if(app.tool==='hand'){const dx=(w.x-app.handStart.x)*app.scale, dy=(w.y-app.handStart.y)*app.scale; app.panX=app.handStart.panX+dx; app.panY=app.handStart.panY+dy; applyView();}
}
function endAt(p){
  if(!app.drawing) return; const w=screen2world(p);
  if(app.tool==='pen'||app.tool==='marker'||app.tool==='eraser'){app.strokes.push(app.current); pushHistory(); app.current=null; saveSnapshot();}
  else if(app.tool==='line'){app.strokes.push({type:'line',a:app.lineStart,b:w,w:app.penSize,color:app.penColor,alpha:1}); app.lineStart=null; clearOverlay(); pushHistory(); saveSnapshot();}
  app.drawing=false;
}

els.workspace.addEventListener('pointerdown', e=>{
  if(e.button!==0) return; // 左クリック/タッチ/ペンのみ
  const target = e.target;
  if (target.closest('.panel')) return; // パネル上は無視
  app.activePointer = e.pointerId;
  els.workspace.setPointerCapture(app.activePointer);
  beginAt({x:e.clientX, y:e.clientY});
  e.preventDefault();
});
els.workspace.addEventListener('pointermove', e=>{
  if(app.activePointer!==e.pointerId || !app.drawing) return;
  moveAt({x:e.clientX, y:e.clientY}); e.preventDefault();
}, {passive:false});
function endPointer(e){ if(app.activePointer!==e.pointerId) return; endAt({x:e.clientX, y:e.clientY}); els.workspace.releasePointerCapture(app.activePointer); app.activePointer=null; e.preventDefault(); }
els.workspace.addEventListener('pointerup', endPointer);
els.workspace.addEventListener('pointercancel', endPointer);

/* ピンチズーム（2本指） */
let pinch=null;
els.workspace.addEventListener('touchstart', e=>{
  if(e.touches.length===2){
    const[a,b]=e.touches; const dx=b.clientX-a.clientX, dy=b.clientY-a.clientY;
    pinch={d:Math.hypot(dx,dy), start:app.scale, cx:(a.clientX+b.clientX)/2, cy:(a.clientY+b.clientY)/2};
  }
},{passive:true});
els.workspace.addEventListener('touchmove', e=>{
  if(pinch && e.touches.length===2){
    const[a,b]=e.touches; const dx=b.clientX-a.clientX, dy=b.clientY-a.clientY; const d=Math.hypot(dx,dy);
    setScale(pinch.start*(d/pinch.d), {x:(a.clientX+b.clientX)/2, y:(a.clientY+b.clientY)/2});
    e.preventDefault();
  }
},{passive:false});
els.workspace.addEventListener('touchend', ()=>{ if(pinch) pinch=null; }, {passive:true});

/* ホイールズーム（Ctrl+Wheel） */
els.workspace.addEventListener('wheel', e=>{ if(!e.ctrlKey) return; e.preventDefault();
  const d=-Math.sign(e.deltaY)*app.step; setScale(app.scale+d, {x:e.clientX,y:e.clientY}); }, {passive:false});

/* ===== Grid / History ===== */
function toggleGrid(){ app.grid=!app.grid; els.gridBtn.setAttribute('aria-pressed', app.grid?'true':'false'); els.workspace.classList.toggle('grid-on', app.grid); }
function pushHistory(){ app.history.push(JSON.stringify(app.strokes)); if(app.history.length>300) app.history.shift(); app.future.length=0; }
function undo(){ if(app.history.length){ app.future.push(JSON.stringify(app.strokes)); app.strokes=JSON.parse(app.history.pop()); redraw(); saveSnapshot(); } }
function redo(){ if(app.future.length){ app.history.push(JSON.stringify(app.strokes)); app.strokes=JSON.parse(app.future.pop()); redraw(); saveSnapshot(); } }

/* ===== Persistence ===== */
const DB='notelink-db', STORE='doc', KEY='latest';
function idbOpen(){return new Promise((ok,ng)=>{const r=indexedDB.open(DB,1); r.onupgradeneeded=e=>{const db=e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE);}; r.onsuccess=()=>ok(r.result); r.onerror=()=>ng(r.error);});}
async function idbSet(v){try{const db=await idbOpen(); const tx=db.transaction(STORE,'readwrite'); tx.objectStore(STORE).put(v,KEY); await new Promise((ok,ng)=>{tx.oncomplete=ok; tx.onerror=()=>ng(tx.error)}); db.close();}catch{}}
async function idbGet(){try{const db=await idbOpen(); const tx=db.transaction(STORE,'readonly'); const req=tx.objectStore(STORE).get(KEY);
  const v=await new Promise((ok,ng)=>{req.onsuccess=()=>ok(req.result); req.onerror=()=>ng(req.error)}); db.close(); return v;}catch{return null}}
function saveSnapshot(){ idbSet(JSON.stringify({strokes:app.strokes, scale:app.scale, panX:app.panX, panY:app.panY, penSize:app.penSize, penColor:app.penColor, fontPt:app.fontPt})); }
async function restoreSnapshot(){ const raw=await idbGet(); if(!raw) { pushHistory(); return; }
  try{ const s=JSON.parse(raw); app.strokes=s.strokes||[]; app.scale=s.scale??1; app.panX=s.panX??0; app.panY=s.panY??0;
    app.penSize=s.penSize??2; els.penSize.value=app.penSize; app.penColor=s.penColor||'#ffffff'; els.penColor.value=app.penColor;
    app.fontPt=s.fontPt??14; els.fontSize.value=app.fontPt; updatePenLabel(); updateFontLabel(); applyView(); redraw(); pushHistory();
  }catch{ pushHistory(); } }
document.addEventListener('visibilitychange', ()=>{ if(document.visibilityState==='hidden') saveSnapshot(); });
window.addEventListener('pagehide', saveSnapshot);
window.addEventListener('pageshow', restoreSnapshot);

/* ===== Panels ===== */
function openPanel(btn,p){btn.classList.add('is-open'); btn.setAttribute('aria-pressed','true'); p.hidden=false; centerPanel(p);}
function closePanel(btn,p){btn.classList.remove('is-open'); btn.setAttribute('aria-pressed','false'); p.hidden=true;}
function togglePanel(btn,p){ (btn.getAttribute('aria-pressed')==='true') ? closePanel(btn,p) : openPanel(btn,p); }
['click','mousedown','touchstart'].forEach(t=>{
  els.settingsPanel.addEventListener(t, e=>e.stopPropagation(), {passive:true});
  els.kbdPanel.addEventListener(t, e=>e.stopPropagation(), {passive:true});
});

/* ===== Export / Print / Share / Fullscreen ===== */
function exportPNG(){ const a=document.createElement('a'); a.download=`notelink-${Date.now()}.png`; a.href=els.canvas.toDataURL('image/png'); a.click(); }
async function share(){ try{
  const blob=await (await fetch(els.canvas.toDataURL('image/png'))).blob();
  if (navigator.canShare && navigator.canShare({files:[new File([blob],'note.png',{type:'image/png'})]}))
    await navigator.share({files:[new File([blob],'note.png',{type:'image/png'})]});
  else exportPNG();
}catch{ exportPNG(); }}

/* ===== Wiring ===== */
window.addEventListener('resize', fitCanvas);

els.zoomOut.addEventListener('click', ()=>setScale(app.scale-app.step));
els.zoomIn .addEventListener('click', ()=>setScale(app.scale+app.step));
els.undo.addEventListener('click', undo);
els.redo.addEventListener('click', redo);
els.print.addEventListener('click', ()=>window.print());
els.png.addEventListener('click', exportPNG);
els.share.addEventListener('click', share);
els.fs.addEventListener('click', async()=>{ try{ if(!document.fullscreenElement){ await document.documentElement.requestFullscreen(); els.fs.textContent='全画面終了'; } else { await document.exitFullscreen(); els.fs.textContent='全画面'; } }catch{} });

els.penBtn.addEventListener('click', ()=>setTool('pen'));
els.markerBtn.addEventListener('click', ()=>setTool('marker'));
els.lineBtn.addEventListener('click', ()=>setTool('line'));
els.eraserBtn.addEventListener('click', ()=>setTool('eraser'));
els.handBtn.addEventListener('click', ()=>setTool('hand'));
els.gridBtn.addEventListener('click', toggleGrid);

els.settingsBtn.addEventListener('click', ()=>togglePanel(els.settingsBtn, els.settingsPanel));
els.closeSettings.addEventListener('click', ()=>closePanel(els.settingsBtn, els.settingsPanel));
els.kbdBtn.addEventListener('click', ()=>togglePanel(els.kbdBtn, els.kbdPanel));
els.closeKbd.addEventListener('click', ()=>closePanel(els.kbdBtn, els.kbdPanel));

els.penSize.addEventListener('input', ()=>{ app.penSize=parseFloat(els.penSize.value); updatePenLabel(); }, {passive:true});
els.penColor.addEventListener('input', ()=>{ app.penColor=els.penColor.value; }, {passive:true});
els.fontSize.addEventListener('input', ()=>{ app.fontPt=parseInt(els.fontSize.value,10); updateFontLabel(); }, {passive:true});

/* ===== Zoom helpers ===== */
function setScale(next, center){
  app.scale=Math.max(app.min, Math.min(app.max, next));
  if(center){ const before=screen2world(center); applyView(); const after=screen2world(center); app.panX+=(after.x-before.x)*app.scale; app.panY+=(after.y-before.y)*app.scale; }
  applyView();
}

/* ===== Init ===== */
function init(){ setTool('pen'); fitCanvas(); applyView(); updatePenLabel(); updateFontLabel(); restoreSnapshot();
  centerPanel(els.settingsPanel); centerPanel(els.kbdPanel);
}
init();
</script>
</body>
</html>
