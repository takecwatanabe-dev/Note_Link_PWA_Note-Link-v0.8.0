<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no">
<title>NOTE LINK ‚Äî V0.8.0 RESTORE (SW-off + DPR-fix)</title>

<style>
:root{--bg:#0f1115;--panel:#181b22;--line:#2a2f3a;--text:#e6e9ef;--accent:#50c878;--danger:#e45858;}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:14px/1.6 system-ui,"Noto Sans JP",sans-serif}
.topbar{display:flex;align-items:center;gap:.75rem;padding:.5rem .75rem;background:var(--panel);border-bottom:1px solid var(--line);position:sticky;top:0;z-index:20}
.topbar .app-title{font-weight:700;letter-spacing:.04em}.topbar .spacer{flex:1}.topbar .version{opacity:.8}
.layout{display:grid;grid-template-columns:64px 1fr;min-height:calc(100vh - 44px)}
.toolbar{display:flex;flex-direction:column;gap:.5rem;padding:.5rem;background:var(--panel);border-right:1px solid var(--line);z-index:30}
.tb-btn{display:grid;place-items:center;height:48px;border:1px solid var(--line);background:#13161c;color:var(--text);border-radius:12px;font-size:20px;cursor:pointer}
.tb-btn:hover{outline:2px solid var(--accent)} .tb-btn.active{background:#0b2c21}
.tb-btn.danger{border-color:#5b2b2b}
.stage-wrap{position:relative;overflow:hidden}
.canvas-host{width:100%;height:calc(100vh - 44px);touch-action:none;outline:none}
#stage{width:100%;height:100%;display:block;background:#0b0e14;touch-action:none;pointer-events:auto}
.hud{position:absolute;left:8px;bottom:8px;display:flex;gap:.75rem;background:#0b0e14cc;padding:.4rem .6rem;border:1px solid var(--line);border-radius:10px;backdrop-filter:blur(6px)}
.modal{border:none;border-radius:16px;background:var(--panel);color:var(--text);padding:0;max-width:min(560px, calc(100vw - 24px))}
.modal::backdrop{background:#0006}
.modal header{display:flex;align-items:center;gap:.5rem;padding:.6rem .8rem;border-bottom:1px solid var(--line)}
.modal header h3{margin:0;font-size:16px}
.modal .close{margin-left:auto;inline-size:36px;block-size:36px;border:none;border-radius:10px;background:#222;color:var(--text);font-size:18px;cursor:pointer}
.modal section{padding:.8rem}
.settings label{display:block;margin:.6rem 0}
.settings .units{display:flex;gap:1rem;opacity:.9}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:.5rem}
.kbd{height:44px;border:1px solid var(--line);border-radius:10px;background:#141820;font-size:18px}
@media (max-width:900px){.layout{grid-template-columns:56px 1fr}}
</style>

<!-- Âè§„ÅÑService Worker„Å®„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíËß£Èô§ÔºàÁÑ°„Åë„Çå„Å∞‰Ωï„ÇÇ„Åó„Å™„ÅÑÔºâ -->
<script>
(async()=>{try{
  if('serviceWorker' in navigator){
    const regs = await navigator.serviceWorker.getRegistrations();
    for(const r of regs) await r.unregister();
  }
  if('caches' in window){
    for(const k of await caches.keys()) await caches.delete(k);
  }
}catch(e){}})();
</script>
</head>
<body>
<header class="topbar">
  <div class="app-title">NOTE LINK</div><div class="spacer"></div>
  <div class="version">V0.8.0 RESTORE</div>
</header>

<div class="layout">
  <aside id="toolbar" class="toolbar">
    <button class="tb-btn" data-tool="pen"    title="„Éö„É≥ (P)">‚úí</button>
    <button class="tb-btn" data-tool="eraser" title="Ê∂à„Åó„Ç¥„É† (E)">ü©π</button>
    <button class="tb-btn" data-tool="hand"   title="„Éè„É≥„Éâ/ÁßªÂãï (H)">‚úã</button>
    <button class="tb-btn" data-tool="keyboard" title="„Ç≠„Éº„Éú„Éº„Éâ (K)">‚å®</button>
    <button class="tb-btn" data-tool="gear"   title="Ë®≠ÂÆö">‚öô</button>
    <button class="tb-btn danger" data-action="clearAll" title="ÂÖ®Ê∂àÂéª">üóë</button>
  </aside>

  <main class="stage-wrap">
    <div id="canvasHost" class="canvas-host" tabindex="0">
      <canvas id="stage"></canvas>
    </div>
    <div class="hud">
      <span id="hudTool">Tool: Pen</span>
      <span id="hudSize">Size: 2.0 mm (7.6 px / 5.7 pt)</span>
      <span id="hudPressure">Pressure: 0.00</span>
      <span id="hudTilt">Tilt: 0/0</span>
      <span id="hudScale">Scale: 100%</span>
    </div>
  </main>
</div>

<!-- „Ç≠„Éº„Éú„Éº„Éâ -->
<dialog id="dlgKeyboard" class="modal">
  <header><h3>„Ç≠„Éº„Éú„Éº„Éâ</h3><button class="close" data-close>√ó</button></header>
  <section><div class="grid2">
    <button class="kbd">Ôº°</button><button class="kbd">„ÅÇ</button>
    <button class="kbd">Ôºë</button><button class="kbd">Ôºã</button>
    <button class="kbd">‚àí</button><button class="kbd">√ó</button>
  </div></section>
</dialog>

<!-- Ë®≠ÂÆö -->
<dialog id="dlgGear" class="modal">
  <header><h3>Ë®≠ÂÆö</h3><button class="close" data-close>√ó</button></header>
  <section class="settings">
    <label>„Éö„É≥Â§™„Åï <input id="penSize" type="range" min="0.2" max="5" step="0.1" value="2"></label>
    <div class="units"><span id="unitMM">2.0 mm</span><span id="unitPX">7.6 px</span><span id="unitPT">5.7 pt</span></div>
    <label><input id="showLive" type="checkbox" checked> ÂúßÂäõ/ÂÇæ„Åç„ÇíHUDË°®Á§∫</label>
  </section>
</dialog>

<script>
/* ===== 1) „Çπ„Éà„Ç¢ & ÊèèÁîªÔºàDPRÂØæÂøúÔºâ ===== */
let DPR = 1;
const store = { strokes: [], scale: 1, offsetX: 0, offsetY: 0 };

function addStroke(s){ store.strokes.push(s); }
function clearAll(){ store.strokes.length = 0; }

function redraw(ctx){
  ctx.setTransform(1,0,0,1,0,0);
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);
  ctx.setTransform(DPR*store.scale,0,0,DPR*store.scale,DPR*store.offsetX,DPR*store.offsetY);
  for(const s of store.strokes){ if(s.tool==='eraser') continue; drawStroke(ctx,s); }
}
function drawStroke(ctx,s){
  if(!s.points||s.points.length<1) return;
  ctx.lineCap='round'; ctx.lineJoin='round'; ctx.strokeStyle=s.color||'#e6e9ef';
  ctx.beginPath();
  for(let i=1;i<s.points.length;i++){
    const a=s.points[i-1], b=s.points[i];
    ctx.lineWidth = s.sizePx * (1 + (b.p ?? 1) * 0.6);
    ctx.moveTo(a.x,a.y); ctx.lineTo(b.x,b.y);
  }
  ctx.stroke();
}
function mmToPx(mm){return mm*(96/25.4);} function pxToPt(px){return px*72/96;}
function clamp(v,a,b){return Math.max(a,Math.min(b,v));}

/* ===== 2) ‰∫§Â∑ÆÂà§ÂÆöÔºàÊ∂à„Åó„Ç¥„É†Áî®ÔºöÁ∑öÂàÜ„Å∏„ÅÆÊúÄËøëË∑ùÈõ¢Ôºâ ===== */
function hitStroke(stk,x,y,r){
  if(stk.tool!=='pen') return false; const r2=r*r;
  for(let i=1;i<stk.points.length;i++){
    const a=stk.points[i-1], b=stk.points[i];
    const vx=b.x-a.x, vy=b.y-a.y, wx=x-a.x, wy=y-a.y;
    const c1=vx*wx+vy*wy;
    if(c1<=0){ if((x-a.x)**2+(y-a.y)**2<=r2) return true; continue; }
    const c2=vx*vx+vy*vy;
    if(c2<=c1){ if((x-b.x)**2+(y-b.y)**2<=r2) return true; continue; }
    const t=c1/c2, sx=a.x+t*vx, sy=a.y+t*vy;
    if((x-sx)**2+(y-sy)**2<=r2) return true;
  }
  return false;
}

/* ===== 3) InkÔºà„Ç≠„É£„É≥„Éê„ÇπÁõ¥Áµê„Éª„Ç∫„É¨ÁÑ°„ÅóÔºâ ===== */
function createInk(ctx, target){
  let drawing=false, current=null, activeId=null, ignoreTouches=false;

  const state={ tool:'pen', color:'#e6e9ef', sizeMm:2.0, sizePx:mmToPx(2.0), showLive:true, onLive:(_)=>{} };

  function setTool(t){ state.tool=t; }
  function setSizeMm(mm){ state.sizeMm=mm; state.sizePx=mmToPx(mm); }
  function setShowLive(v){ state.showLive=v; }
  function onLive(fn){ state.onLive=fn; }

  function toLocal(e){
    const r = target.getBoundingClientRect();
    return {
      x:(e.clientX - r.left - store.offsetX)/store.scale,
      y:(e.clientY - r.top  - store.offsetY)/store.scale,
      p:e.pressure||0, tx:e.tiltX||0, ty:e.tiltY||0
    };
  }

  function begin(e){
    const isPen=e.pointerType==='pen', isTouch=e.pointerType==='touch';
    if(isPen) ignoreTouches=true;
    if(isTouch && (ignoreTouches || state.tool==='pen')) return;

    target.setPointerCapture(e.pointerId);
    activeId=e.pointerId; drawing=true;

    if(state.tool==='hand'){
      target.dataset.panX0=e.clientX; target.dataset.panY0=e.clientY;
      target.dataset.offX0=store.offsetX; target.dataset.offY0=store.offsetY; return;
    }
    if(state.tool==='eraser'){
      const p=toLocal(e), r=10/store.scale;
      store.strokes=store.strokes.filter(stk=>!hitStroke(stk,p.x,p.y,r)); redraw(ctx); return;
    }
    const p=toLocal(e);
    current={tool:'pen',color:state.color,sizePx:state.sizePx,points:[p]};
    addStroke(current); redraw(ctx);
  }

  function move(e){
    if(!drawing || (activeId!==null && e.pointerId!==activeId)) return;
    if(state.showLive) state.onLive({p:e.pressure||0, tx:e.tiltX||0, ty:e.tiltY||0});

    if(state.tool==='hand'){
      const dx=e.clientX-Number(target.dataset.panX0), dy=e.clientY-Number(target.dataset.panY0);
      store.offsetX=Number(target.dataset.offX0)+dx; store.offsetY=Number(target.dataset.offY0)+dy; redraw(ctx); return;
    }
    if(state.tool==='eraser'){
      const p=toLocal(e), r=10/store.scale;
      store.strokes=store.strokes.filter(stk=>!hitStroke(stk,p.x,p.y,r)); redraw(ctx); return;
    }
    const p=toLocal(e);
    current.points.push({x:p.x,y:p.y,p:p.p,tx:p.tx,ty:p.ty}); redraw(ctx);
  }

  function end(e){
    if(activeId!==null && e.pointerId!==activeId) return;
    drawing=false; activeId=null; setTimeout(()=>{ignoreTouches=false;},120);
  }

  // ÈáçË¶ÅÔºöÂèñ„Çä„Åì„Åº„ÅóÈò≤Ê≠¢
  target.addEventListener('pointerdown', begin, {passive:false});
  target.addEventListener('pointermove', move,  {passive:false});
  target.addEventListener('pointerrawupdate', move, {passive:false}); // stylusÂêë„Åë
  target.addEventListener('pointerup',   end,   {passive:false});
  target.addEventListener('pointercancel', end, {passive:false});

  // „Ç∫„Éº„É†Ôºà„Éõ„Ç§„Éº„É´Ôºâ
  target.addEventListener('wheel',(e)=>{
    e.preventDefault();
    const s0=store.scale, delta=Math.sign(e.deltaY)*-0.07, s1=clamp(s0*(1+delta), .25, 4);
    const r=target.getBoundingClientRect();
    const cx=e.clientX-r.left-store.offsetX, cy=e.clientY-r.top-store.offsetY;
    store.offsetX-=cx*(s1/s0-1); store.offsetY-=cy*(s1/s0-1);
    store.scale=s1; redraw(ctx);
  },{passive:false});

  return { setTool, setSizeMm, setShowLive, onLive };
}

/* ===== 4) UIÁµêÁ∑ö ===== */
const $=s=>document.querySelector(s), $$=s=>Array.from(document.querySelectorAll(s));
const canvas=$('#stage'), host=$('#canvasHost'); const ctx=canvas.getContext('2d');

function resizeCanvas(){
  DPR = Math.max(1, Math.min(3, window.devicePixelRatio||1));
  const rect=host.getBoundingClientRect();
  canvas.width = Math.floor(rect.width  * DPR);
  canvas.height= Math.floor(rect.height * DPR);
  redraw(ctx);
}
addEventListener('resize', resizeCanvas); resizeCanvas();

const ink=createInk(ctx, canvas);

// Âè≥„ÇØ„É™„ÉÉ„ÇØ‰∏ÄÊôÇ„Éè„É≥„Éâ
let rightDown=false, prevTool='pen';
canvas.addEventListener('pointerdown',e=>{ if(e.button===2){rightDown=true;prevTool=currentTool();ink.setTool('hand');}});
addEventListener('pointerup',e=>{ if(rightDown&&e.button===2){rightDown=false;ink.setTool(prevTool);selectTool(prevTool);} });
addEventListener('contextmenu',e=>{ if(e.target===host||e.target===canvas) e.preventDefault(); });

// HUD/Ë®≠ÂÆö
const hudTool=$('#hudTool'), hudSize=$('#hudSize'), hudPressure=$('#hudPressure'), hudTilt=$('#hudTilt'), hudScale=$('#hudScale');
const penSize=$('#penSize'), unitMM=$('#unitMM'), unitPX=$('#unitPX'), unitPT=$('#unitPT'), showLive=$('#showLive');
function updateUnits(){
  const mm=Number(penSize.value), px=mmToPx(mm), pt=pxToPt(px);
  unitMM.textContent=`${mm.toFixed(1)} mm`;
  unitPX.textContent=`${px.toFixed(1)} px`;
  unitPT.textContent=`${pt.toFixed(1)} pt`;
  hudSize.textContent=`Size: ${mm.toFixed(1)} mm (${px.toFixed(1)} px / ${pt.toFixed(1)} pt)`;
  ink.setSizeMm(mm);
}
penSize.addEventListener('input',updateUnits,{passive:true}); updateUnits();
showLive.addEventListener('change',()=>ink.setShowLive(showLive.checked),{passive:true});
ink.onLive(({p,tx,ty})=>{
  hudPressure.textContent=`Pressure: ${p.toFixed(2)}`;
  hudTilt.textContent=`Tilt: ${tx|0}/${ty|0}`;
  hudScale.textContent=`Scale: ${(store.scale*100)|0}%`;
});

// „ÉÑ„Éº„É´ÂàáÊõø & „ÇØ„É™„Ç¢
function currentTool(){ const a=$('#toolbar .tb-btn.active'); return a?.dataset.tool||'pen'; }
function selectTool(tool){
  $$('#toolbar .tb-btn').forEach(b=>b.classList.remove('active'));
  const t=document.querySelector(`#toolbar .tb-btn[data-tool="${tool}"]`);
  if(t) t.classList.add('active');
  hudTool.textContent=`Tool: ${tool[0].toUpperCase()+tool.slice(1)}`;
  ink.setTool(tool);
  if(tool==='keyboard') openDialog('#dlgKeyboard');
  if(tool==='gear')     openDialog('#dlgGear');
}
$$('#toolbar .tb-btn').forEach(btn=>{
  btn.addEventListener('click',()=>{
    if(btn.dataset.action==='clearAll'){
      if(confirm('ÂÖ®„Å¶„ÅÆÊèèÁîª„ÇíÊ∂àÂéª„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü')){ clearAll(); redraw(ctx); }
      return;
    }
    const tool=btn.dataset.tool; if(tool) selectTool(tool);
  },{passive:true});
});
selectTool('pen');

// „ÉÄ„Ç§„Ç¢„É≠„Ç∞
function bindDialog(dlg){
  dlg.querySelectorAll('[data-close]').forEach(x=>x.addEventListener('click',()=>dlg.close()));
  dlg.addEventListener('cancel',e=>{e.preventDefault();dlg.close();});
  dlg.addEventListener('click',e=>{if(e.target===dlg) dlg.close();});
}
function openDialog(sel){ const dlg=$(sel); if(dlg && typeof dlg.showModal==='function'){ dlg.showModal(); bindDialog(dlg);} }
</script>
</body>
</html>
