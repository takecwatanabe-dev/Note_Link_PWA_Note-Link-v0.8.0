<!doctype html><html lang="ja"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>Note Link mini — v0.7.0-mini-fix20e</title>
<style>
:root{
  --ink:#e6f1ff; --ink-dim:#9bd6e9; --bg:#0b1020;
  --panel:#101827; --accent:#3f78ff;
  --ok:#20e3c2; --muted:#2a3550; --shadow:0 10px 24px rgba(0,0,0,.45);
  --topbar-h:44px; --sidebar-top:44px; --toolbar-w:56px; --zoom:1;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);
  font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN",Meiryo,sans-serif}

/* ★ 上部バーを固定 */
header.topbar{
  position:fixed; top:0; left:0; right:0; z-index:2000;
  height:var(--topbar-h);
  display:flex; align-items:center; gap:8px; padding:0 10px; font-size:12px; color:#fff;
  background:linear-gradient(0deg,rgba(42,84,255,.16),rgba(42,84,255,.16)),var(--accent);
  border-bottom:1px solid rgba(255,255,255,.15);
}
.topbar .sp{flex:1}
.topbar .btn{height:28px;padding:0 10px;border-radius:10px;background:rgba(255,255,255,.2);
  border:1px solid rgba(255,255,255,.22);color:#fff;display:inline-flex;align-items:center;gap:6px}
.topbar .btn:active{transform:translateY(1px)} .build{opacity:.8}

/* 固定ヘッダぶん下げるラッパー */
#wrap{position:relative;height:100%; padding-top:var(--topbar-h)}
#stage{position:absolute; inset:var(--topbar-h) 0 0 0; padding-left:var(--toolbar-w)}
#viewport{position:absolute; inset:0; transform-origin:0 0; transform:scale(var(--zoom));}

/* サイドバー：確実に最前面でクリック可 */
.sidebar{
  position:fixed; z-index:2500; left:0;
  top:var(--topbar-h); bottom:0; width:var(--toolbar-w);
  display:flex; flex-direction:column; align-items:center;
  background:rgba(0,0,0,.86); box-shadow:0 0 0 1px var(--muted) inset;
  pointer-events:auto;
}
.sidebar .rail{width:100%; padding:6px; display:flex; flex-direction:column; gap:8px}
.tool{
  display:grid; place-items:center; width:100%; height:36px; border-radius:10px; cursor:pointer; user-select:none;
  background:rgba(22,26,38,.75); border:1px solid rgba(50,60,100,.6);
  outline:1px solid rgba(79,124,255,.35);
  box-shadow:0 0 0 2px rgba(0,0,0,.12);
  pointer-events:auto;
}
.tool svg{width:18px;height:18px;stroke:var(--ink);fill:none;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
.tool:hover{outline:1px solid rgba(79,124,255,.5)}
.tool.active{outline:1px solid var(--ok)}
.tool[data-tool="toggle"] svg{transition:transform .2s ease}
.sidebar.collapsed .tool[data-tool="toggle"] svg{transform:rotate(180deg)}
.sidebar.collapsed .rail > .tool:not([data-tool="toggle"]){display:none}
.sidebar.collapsed{clip-path:inset(0 0 calc(100% - 45px) 0)}

.panel{
  position:absolute; z-index:2400; left:70px; top:calc(var(--topbar-h) + 10px);
  min-width:380px; padding:10px 14px 12px; border-radius:14px; color:var(--ink);
  background:var(--panel); border:1px solid rgba(255,255,255,.14); box-shadow:var(--shadow);
  display:none; user-select:none;
}
.panel.show{display:block}
.panel .handle{display:flex; align-items:center; gap:8px; margin:-6px -6px 8px; padding:6px;
  border-radius:10px; cursor:grab; touch-action:none}
.panel .handle svg{width:16px;height:16px;stroke:var(--ink-dim)}
.panel .row{display:flex; align-items:center; gap:10px; margin:10px 0}
.panel .row label{width:110px;font-size:12px;color:var(--ink-dim)}
.panel .close{margin-left:auto;height:26px;padding:0 10px;border-radius:8px;
  border:1px solid rgba(255,255,255,.18);background:rgba(255,255,255,.08);color:var(--ink);font-size:14px;line-height:1}

/* キャンバス */
#grid,#guide,#paint{position:absolute;left:var(--toolbar-w);top:0;right:0;bottom:0}
#grid,#guide{z-index:100;pointer-events:none} #paint{z-index:80}

/* テキスト */
.text-layer{position:absolute;left:var(--toolbar-w);top:0;right:0;bottom:0;z-index:120;pointer-events:none}
.note-text{position:absolute;min-width:64px;min-height:28px;padding:6px 8px;color:#eaf3ff;background:transparent;
  outline:1px dashed rgba(255,255,255,.25);border-radius:6px;pointer-events:auto}
.note-text[contenteditable="true"]:focus{outline:2px solid var(--ok)}
.note-text .del{position:absolute;right:-8px;top:-10px;font-size:11px;color:#fff;background:#0008;border:1px solid #fff3;border-radius:8px;padding:2px 6px;display:none}
.note-text:focus-within .del{display:block}

/* ツールチップ（設定だけはダイアログ外へ） */
[data-tip]{position:relative}
[data-tip]::after{
  content:attr(data-tip);position:absolute;left:48px;top:50%;transform:translateY(-50%);
  background:#222a;color:#fff;font-size:12px;padding:4px 8px;border-radius:8px;white-space:nowrap;
  pointer-events:none;opacity:0;translate:0 -4px;transition:.15s
}
[data-tip]:hover::after{opacity:1;translate:0 0}
.sidebar .tool[data-tool="settings"][data-tip]::after{
  left:8px; top:auto; bottom:calc(100% + 8px); transform:none; translate:0 0; z-index:2600;
}

@media print{
  header.topbar,.sidebar,.panel,.build,[data-tip]::after{display:none!important}
  #stage{padding-left:0!important} body,html,#wrap{height:auto}
}
</style>
</head>
<body>
<header class="topbar" id="topbar">
  <strong>Note Link v0.7.0 / No.13</strong>
  <span class="sp"></span>
  <button class="btn" id="btnZoomOut">−</button>
  <button class="btn" id="btnZoomReset">100%</button>
  <button class="btn" id="btnZoomIn">＋</button>
  <button class="btn" id="btnUndo">undo</button>
  <button class="btn" id="btnRedo">redo</button>
  <button class="btn" id="btnPrint">印刷</button>
  <button class="btn" id="btnPng">PNG</button>
  <button class="btn" id="btnShare">共有</button>
  <span class="build">build: mini-fix20e</span>
</header>

<aside class="sidebar" id="sidebar">
  <div class="rail">
    <button class="tool active" data-tool="toggle" data-tip="ツールバーの開閉">
      <svg viewBox="0 0 24 24"><path d="M5 15 L12 7 L19 15 M19 15 L5 15"/></svg>
    </button>
    <button class="tool" data-tool="pen" data-tip="ペン">
      <svg viewBox="0 0 24 24"><path d="M3 21l4-1 12-12-3-3L4 17l-1 4zM14 6l3 3"/></svg>
    </button>
    <button class="tool" data-tool="marker" data-tip="マーカー">
      <svg viewBox="0 0 24 24"><path d="M3 16l10-10 5 5-10 10-5 1 1-6zM13 6l5 5"/></svg>
    </button>
    <button class="tool" data-tool="eraser" data-tip="消しゴム">
      <svg viewBox="0 0 24 24"><path d="M3 15l8-8 6 6-6 6H7zM13 7l4 4"/></svg>
    </button>
    <button class="tool" data-tool="hand" data-tip="選択/パン">
      <svg viewBox="0 0 24 24"><path d="M9 11V6a2 2 0 0 1 4 0v5M13 11V5a2 2 0 1 1 4 0v8M9 11a2 2 0 0 1 4 0v8l-2 2-4-4-2-6 2-1z"/></svg>
    </button>
    <button class="tool" data-tool="keyboard" data-tip="テキスト">
      <svg viewBox="0 0 24 24"><rect x="3" y="7" width="18" height="10" rx="2"></rect><path d="M7 10h10M5 13h14"/></svg>
    </button>
    <button class="tool" data-tool="settings" data-tip="ツール設定（表示/非表示）">
      <svg viewBox="0 0 24 24"><path d="M12 7.5a4.5 4.5 0 1 1 0 9 4.5 4.5 0 0 1 0-9zM4 13h2l1 2-1 2H4l-1-2 1-2zm14 0h2l1 2-1 2h-2l-1-2 1-2zM8 4h2l2 1 2-1h2l1 2-1 2h-2l-2-1-2 1H8L7 6l1-2z"/></svg>
    </button>
  </div>
</aside>

<!-- 設定パネル -->
<div class="panel" id="panel">
  <div class="handle" id="panelHandle" data-tip="ドラッグで移動">
    <svg viewBox="0 0 24 24"><path d="M4 7h16M4 12h16M4 17h16"/></svg>
    <div id="panelTool">-</div>
    <button class="close" id="panelClose" aria-label="閉じる" title="閉じる">☒</button>
  </div>
  <div class="row"><label>色</label><input type="color" id="uiColor" value="#cbe58a"></div>
  <div class="row"><label>太さ</label><input type="range" min="1" max="60" value="4" id="uiSize"><span id="uiSizeVal">4px</span></div>
  <div class="row" id="rowAlpha"><label>不透明度</label><input type="range" min="10" max="100" value="100" id="uiAlpha"><span id="uiAlphaVal">100%</span></div>
  <div class="row" id="rowLineCap"><label>端の形</label>
    <select id="uiCap"><option value="butt">□ 角</option><option value="round">● 丸</option></select>
  </div>
  <div class="row" id="rowStraight"><label>直線モード</label>
    <label><input type="checkbox" id="uiStraight">（モバイル / 15°刻み）</label>
    <label><input type="checkbox" id="uiGridFirst">グリッド優先</label>
  </div>
  <div class="row" id="rowGrid"><label>グリッド</label>
    <label><input type="checkbox" id="uiGrid"> 表示</label>
    <select id="uiGridStep"><option value="5">5mm</option><option value="10" selected>10mm</option></select>
    <input type="color" id="uiGridColor" value="#3a4f7a"/>
  </div>
  <div class="row" id="rowTextOps" style="display:none">
    <label>テキスト</label>
    <button id="btnTextAdd">テキストを追加</button>
    <button id="btnTextBold">太字</button>
    <button id="btnTextIt">斜体</button>
    <button id="btnTextDel">選択削除</button>
    <button id="btnTextBoxDel">枠ごと削除</button>
  </div>
</div>

<div id="wrap"><div id="stage">
  <div id="viewport">
    <canvas id="grid"></canvas>
    <canvas id="guide"></canvas>
    <canvas id="paint"></canvas>
    <div class="text-layer" id="textLayer"></div>
  </div>
</div></div>

<script>
const $=s=>document.querySelector(s), $$=s=>[...document.querySelectorAll(s)];
const DPR=Math.max(1,devicePixelRatio||1);
const topbar=$('#topbar'), sidebar=$('#sidebar'), panel=$('#panel');
const cvGrid=$('#grid'), ctxGrid=cvGrid.getContext('2d');
const cvGuide=$('#guide'), ctxGuide=cvGuide.getContext('2d');
const cv=$('#paint'), ctx=cv.getContext('2d',{alpha:true});
const textLayer=$('#textLayer'), viewport=$('#viewport');

let W=0,H=0, zoom=1;
let tool='pen';
const perTool={ pen:{color:'#cbe58a',size:4,alpha:1,cap:'butt',straight:false},
                marker:{color:'#cbe58a',size:16,alpha:.4,cap:'butt',straight:false},
                eraser:{size:24}, hand:{}, keyboard:{} };

let color=perTool.pen.color, size=perTool.pen.size, alpha=1, cap='butt';
let straightToggle=false, straightKey=false, gridOn=false, gridStepMM=10, gridColor='#3a4f7a', gridFirst=false;

function applyBars(){
  const h=Math.round(topbar.getBoundingClientRect().height)||44;
  document.documentElement.style.setProperty('--topbar-h', h+'px');
  document.documentElement.style.setProperty('--sidebar-top', h+'px');
}

/* ===== 保持復元つきリサイズ ===== */
let resizeLock=false;
function resize(){
  if(resizeLock) return; resizeLock=true;
  const prevW=cv.width, prevH=cv.height;
  const prevURL = (prevW && prevH) ? cv.toDataURL('image/png') : null;

  applyBars();
  const r=viewport.getBoundingClientRect();
  W=Math.round(r.width/zoom); H=Math.round(r.height/zoom);
  [cvGrid,cvGuide,cv].forEach(c=>{
    c.width=Math.round(W*DPR); c.height=Math.round(H*DPR);
    c.style.width=(W*zoom)+'px'; c.style.height=(H*zoom)+'px';
  });
  drawGrid();

  if(prevURL){
    const img=new Image();
    img.onload=()=>{ ctx.drawImage(img,0,0,prevW,prevH,0,0,cv.width,cv.height); resizeLock=false; };
    img.src=prevURL;
  }else{
    resizeLock=false;
  }
}
addEventListener('resize', resize);
addEventListener('orientationchange', ()=>setTimeout(resize,50));
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) setTimeout(resize,50); });

/* ==== toolbar ==== */
function setActiveTool(t){
  const prev=tool; perTool[prev] && Object.assign(perTool[prev], {color,size,alpha,cap,straight:straightToggle});
  tool=t; $$('.tool').forEach(b=>b.classList.toggle('active', b.dataset.tool===t));
  $('#panelTool').textContent=t;
  if(perTool[t]){ ({color,size,alpha=alpha,cap=cap,straight:straightToggle=false} = Object.assign({alpha,cap,straight:false}, perTool[t])); }
  $('#rowAlpha').style.display   = (t==='marker') ? '' : 'none';
  $('#rowLineCap').style.display = (t==='marker'||t==='pen') ? '' : 'none';
  $('#rowStraight').style.display= (t==='pen'||t==='marker') ? '' : 'none';
  $('#rowTextOps').style.display = (t==='keyboard') ? '' : 'none';
  syncUI();
}

/* ★ 個別結線＋イベント委譲の二段構え（確実に反応させる） */
$$('.tool').forEach(btn=>{
  btn.addEventListener('click', ()=>handleTool(btn.dataset.tool));
});
document.addEventListener('click', (e)=>{
  const b=e.target.closest('.tool'); if(!b) return;
  handleTool(b.dataset.tool);
});
function handleTool(t){
  if(t==='toggle'){ sidebar.classList.toggle('collapsed'); return; }
  if(t==='settings'){
    panel.classList.toggle('show');
    $$('.tool[data-tool="settings"]').forEach(b=>b.classList.toggle('active', panel.classList.contains('show')));
    return;
  }
  setActiveTool(t);
}

/* ==== panel drag ==== */
(()=>{
  let id=null, sx=0,sy=0,ox=0,oy=0,drag=false;
  const handle=$('#panelHandle');
  function down(e){ drag=true; id=e.pointerId; panel.setPointerCapture(id);
    sx=e.clientX; sy=e.clientY; const r=panel.getBoundingClientRect(); ox=r.left; oy=r.top; e.preventDefault(); }
  function move(e){ if(!drag||e.pointerId!==id) return; const nx=ox+(e.clientX-sx), ny=oy+(e.clientY-sy);
    panel.style.left=Math.max(56,nx)+'px';
    const top=parseInt(getComputedStyle(document.documentElement).getPropertyValue('--topbar-h'))+6;
    panel.style.top=Math.max(top,ny)+'px'; }
  function up(e){ if(e.pointerId!==id) return; drag=false; try{ panel.releasePointerCapture(id);}catch{} id=null; }
  handle.addEventListener('pointerdown',down,{passive:false});
  panel.addEventListener('pointermove',move,{passive:false});
  panel.addEventListener('pointerup',up,{passive:false});
  panel.addEventListener('pointercancel',up,{passive:false});

  const closeBtn = $('#panelClose');
  if(closeBtn){
    closeBtn.addEventListener('click', ()=>{
      panel.classList.remove('show');
      $$('.tool[data-tool="settings"]').forEach(b=>b.classList.remove('active'));
    });
  }
})();

/* ==== panel inputs ==== */
const ui={ color:$('#uiColor'), size:$('#uiSize'), alpha:$('#uiAlpha'),
  sizeVal:$('#uiSizeVal'), alphaVal:$('#uiAlphaVal'), cap:$('#uiCap'),
  straight:$('#uiStraight'), gridFirst:$('#uiGridFirst'),
  gOn:$('#uiGrid'), gStep:$('#uiGridStep'), gColor:$('#uiGridColor') };

function pxToMm(px){ return px*25.4/96; }
function syncUI(){
  ui.color.value=color; ui.size.value=size; ui.sizeVal.textContent=`${size}px  (${pxToMm(size).toFixed(2)} mm)`;
  ui.alpha.value=Math.round(alpha*100); ui.alphaVal.textContent=Math.round(alpha*100)+'%';
  ui.cap.value=cap; ui.straight.checked=straightToggle; ui.gridFirst.checked=gridFirst;
  ui.gOn.checked=gridOn; ui.gStep.value=String(gridStepMM); ui.gColor.value=gridColor;
}
function onPanelChange(){
  color=ui.color.value; size=+ui.size.value; ui.sizeVal.textContent=`${size}px  (${pxToMm(size).toFixed(2)} mm)`;
  alpha=+ui.alpha.value/100; ui.alphaVal.textContent=Math.round(alpha*100)+'%';
  cap=ui.cap.value; straightToggle=ui.straight.checked; gridFirst=ui.gridFirst.checked;
  gridOn=ui.gOn.checked; gridStepMM=+ui.gStep.value; gridColor=ui.gColor.value;
  drawGrid();
}
Object.values(ui).forEach(el=>el?.addEventListener?.('input',onPanelChange));

/* ==== zoom ==== */
function setZoom(z){
  zoom=Math.min(3,Math.max(0.5, z));
  document.documentElement.style.setProperty('--zoom', zoom);
  $('#btnZoomReset').textContent = Math.round(zoom*100) + '%';
  resize();
}
$('#btnZoomIn').addEventListener('click',()=>setZoom(zoom+0.1));
$('#btnZoomOut').addEventListener('click',()=>setZoom(zoom-0.1));
$('#btnZoomReset').addEventListener('click',()=>setZoom(1));

/* ==== grid/canvas ==== */
function clear(c){ c.getContext('2d').clearRect(0,0,c.width,c.height) }
function mmToPx(mm){ return mm*96/25.4*DPR }
function drawGrid(){
  clear(cvGrid); if(!gridOn) return;
  const step=mmToPx(gridStepMM), s=ctxGrid, ox=0.5*DPR, oy=0.5*DPR;
  s.save(); s.lineWidth=1; s.strokeStyle=gridColor+'CC';
  s.beginPath();
  for(let x=ox;x<=cvGrid.width;x+=step){ s.moveTo(x,0); s.lineTo(x,cvGrid.height); }
  for(let y=oy;y<=cvGrid.height;y+=step
